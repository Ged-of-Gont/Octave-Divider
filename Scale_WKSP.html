<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Everything Under $12 â€“ Final Merge</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100;200;300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /************************************************************************
     * 1) CSS CUSTOM PROPERTIES (Variables)
     ************************************************************************/
    :root {
      /* General Layout/Color */
      --bg-color: #0b0f1a;
      --text-color: #e0e0e0;
      --header-bg-gradient: linear-gradient(90deg, #112, #224);
      --header-color: #00ffe0;
      --header-border-color: #18e3ea;

      /* Button + Input Styles */
      --input-bg-color: #101828;
      --input-text-color: #ccffff;
      --select-bg-color: #101828;
      --select-text-color: #99ffff;
      --button-bg: #0fd2ba;
      --button-text: #002;
      --button-border-color: #09aa9a;
      --button-hover-bg: #00ffe0;
      --button-disabled-bg: #444;
      --button-disabled-text: #999;

      /* Canvas + Drawing Colors */
      --canvas-gradient-start: rgb(25, 13, 52);
      --canvas-gradient-end: rgb(49, 25, 77);
      --canvas-line-color: #0af;
      --canvas-vertical-line-color: #66b0ff;
      --interval-label-color: #fffbcc;
      --ratio-label-color: #f0c;
      --freq-label-color: #0ff;

      /* Particle Colors + Behavior */
      --particle-saturation: 100%;
      --particle-lightness: 60%;
      --drag-tolerance-px: 10;
      --default-particle-count: 25;
      --particle-stdev: 20;
      --particle-velocity-scale: 0.2;
      --particle-lifetime-base: 1000;  /* in ms */
      --particle-lifetime-random: 1000;
    }

    /************************************************************************
     * 2) Base Page / Layout
     ************************************************************************/
    body {
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
      font-size: 1.2rem;
    }
    header {
      padding: 1rem;
      background: var(--header-bg-gradient);
      color: var(--header-color);
      font-weight: 700;
      text-shadow: 1px 1px #000;
      border-bottom: 2px solid var(--header-border-color);
      font-size: 2rem;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
    }
    .spacer {
      width: 100px;
    }

    /************************************************************************
     * 3) Form Inputs, Buttons
     ************************************************************************/
    label, input, select, button {
      font-family: 'JetBrains Mono', monospace;
      text-transform: uppercase;
    }
    input[type="number"], input[type="text"] {
      padding: 10px;
      height: 40px;
      width: 90px;
      border: 1px solid #444;
      background: var(--input-bg-color);
      color: var(--input-text-color);
      outline: none;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: textfield;
      font-size: 0.9rem;
    }
    select {
      padding: 10px 20px 10px 10px;
      height: 40px;
      border: 1px solid #333;
      background: var(--select-bg-color) 
                  url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="6"><path fill="%2399ffff" d="M0 0l5 6 5-6z"/></svg>') 
                  no-repeat right 10px center;
      background-size: 10px 6px;
      color: var(--select-text-color);
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      font-size: 0.9rem;
    }
    button {
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 300;
      font-size: 1rem;
      padding: 10px 1rem;
      height: 40px;
      background: var(--button-bg);
      color: var(--button-text);
      border: 2px solid var(--button-border-color);
      cursor: pointer;
      box-shadow: 2px 2px 4px #000;
      border-radius: 0;
    }
    button:hover {
      background: var(--button-hover-bg);
      color: var(--button-text);
    }
    button:disabled {
      background: var(--button-disabled-bg);
      color: var(--button-disabled-text);
      border-color: #666;
      cursor: not-allowed;
    }

    /************************************************************************
     * 4) Canvas Container
     ************************************************************************/
    #canvas-container {
      width: 100%;
      margin: 0;
      padding: 2rem;
      background: var(--bg-color);
      box-sizing: border-box;
    }
    #scale-canvas {
      display: block;
      width: 100%;
      height: 50vh;
      background: linear-gradient(270deg, 
                                  var(--canvas-gradient-start), 
                                  var(--canvas-gradient-end));
    }
  </style>
</head>
<body>
<header>
  <h1>Everything Under $12</h1>
</header>

<div class="controls">
  <label>Tonic Frequency:</label>
  <select id="noteSelect">
    <option value="110.00">A2 (~110.00 Hz)</option>
    <option value="116.54">A#2 (~116.54 Hz)</option>
    <option value="123.47">B2 (~123.47 Hz)</option>
    <option value="130.81" selected>C3 (~130.81 Hz)</option>
    <option value="138.59">C#3 (~138.59 Hz)</option>
    <option value="146.83">D3 (~146.83 Hz)</option>
    <option value="155.56">D#3 (~155.56 Hz)</option>
    <option value="164.81">E3 (~164.81 Hz)</option>
    <option value="174.61">F3 (~174.61 Hz)</option>
    <option value="185.00">F#3 (~185.00 Hz)</option>
    <option value="196.00">G3 (~196.00 Hz)</option>
    <option value="207.65">G#3 (~207.65 Hz)</option>
    <option value="220.00">A3 (~220.00 Hz)</option>
    <option value="233.08">A#3 (~233.08 Hz)</option>
    <option value="246.94">B3 (~246.94 Hz)</option>
    <option value="261.63">C4 (~261.63 Hz)</option>
    <option value="277.18">C#4 (~277.18 Hz)</option>
    <option value="293.66">D4 (~293.66 Hz)</option>
    <option value="311.13">D#4 (~311.13 Hz)</option>
    <option value="329.63">E4 (~329.63 Hz)</option>
    <option value="349.23">F4 (~349.23 Hz)</option>
    <option value="369.99">F#4 (~369.99 Hz)</option>
    <option value="392.00">G4 (~392.00 Hz)</option>
    <option value="415.30">G#4 (~415.30 Hz)</option>
    <option value="440.00">A4 (~440.00 Hz)</option>
  </select>
  <input id="tonicInput" type="number" value="130.81" step="0.01" />
  <button id="setTonicBtn">Set Tonic</button>

  <div class="spacer"></div>
  <label>New Interval (1 < x < 2):</label>
  <input id="intervalInput" type="text" placeholder="3/2 or 1.414" />
  <button id="addIntervalBtn">Add Interval</button>
  <button id="clearAllBtn">Clear All</button>

  <div class="spacer"></div>
  <label>Scale Presets:</label>
  <select id="presetSelect">
    <optgroup label="Harmonic">
      <option value="harmonic-4">4 partials</option>
      <option value="harmonic-5">5 partials</option>
      <option value="harmonic-6">6 partials</option>
      <option value="harmonic-7">7 partials</option>
      <option value="harmonic-8">8 partials</option>
      <option value="harmonic-9">9 partials</option>
      <option value="harmonic-10">10 partials</option>
      <option value="harmonic-11">11 partials</option>
      <option value="harmonic-12">12 partials</option>
      <option value="harmonic-13">13 partials</option>
      <option value="harmonic-14">14 partials</option>
      <option value="harmonic-15">15 partials</option>
      <option value="harmonic-16">16 partials</option>
      <option value="harmonic-17">17 partials</option>
      <option value="harmonic-18">18 partials</option>
      <option value="harmonic-19">19 partials</option>
      <option value="harmonic-20">20 partials</option>
      <option value="harmonic-21">21 partials</option>
      <option value="harmonic-22">22 partials</option>
      <option value="harmonic-23">23 partials</option>
      <option value="harmonic-24">24 partials</option>
    </optgroup>
    <optgroup label="Equal Temper">
      <option value="equal-2">2 TET</option>
      <option value="equal-3">3 TET</option>
      <option value="equal-4">4 TET</option>
      <option value="equal-5">5 TET</option>
      <option value="equal-6">6 TET</option>
      <option value="equal-7">7 TET</option>
      <option value="equal-8">8 TET</option>
      <option value="equal-9">9 TET</option>
      <option value="equal-10">10 TET</option>
      <option value="equal-11">11 TET</option>
      <option value="equal-12">12 TET</option>
      <option value="equal-13">13 TET</option>
      <option value="equal-18">18 TET</option>
      <option value="equal-19">19 TET</option>
      <option value="equal-22">22 TET</option>
      <option value="equal-24">24 TET</option>
      <option value="equal-27">27 TET</option>
      <option value="equal-28">28 TET</option>
      <option value="equal-29">29 TET</option>
      <option value="equal-31">31 TET</option>
    </optgroup>
    <optgroup label="Custom">
      <option value="custom-comingsoon">Coming soon!</option>
    </optgroup>
  </select>
  <button id="playScaleBtn">Play Scale</button>
</div>

<div id="canvas-container">
  <canvas id="scale-canvas"></canvas>
</div>

<div class="controls">
  <button id="saveBtn">Save</button>
  <button id="loadBtn">Load</button>
  <input type="file" id="fileInput" accept="application/json" style="display:none" />
  <label for="formatSelect">Format:</label>
  <select id="formatSelect">
    <option value="json">JSON</option>
    <option value="scl">SCL only</option>
    <option value="scl_kbm">SCL + KBM</option>
    <option value="tun">TUN (AnaMark)</option>
  </select>
  <div class="spacer"></div>
  <label for="refMidiNoteInput">Ref MIDI note:</label>
  <input id="refMidiNoteInput" type="number" value="60" min="0" max="127" />
  <label for="refFreqInput">Ref freq (Hz):</label>
  <input id="refFreqInput" type="number" value="261.63" step="0.01" />
  <label for="lowestNoteInput">Lowest MIDI note:</label>
  <input id="lowestNoteInput" type="number" value="0" min="0" max="127" />
  <label for="highestNoteInput">Highest MIDI note:</label>
  <input id="highestNoteInput" type="number" value="127" min="0" max="127" />
</div>

<script>
  /**************************************************************************
   * 1) Variables + Setup
   **************************************************************************/
  const cssVars = getComputedStyle(document.documentElement);

  const DRAG_TOLERANCE_PX  = parseFloat(cssVars.getPropertyValue("--drag-tolerance-px")) || 10;
  const DEFAULT_PARTICLE_COUNT  = parseFloat(cssVars.getPropertyValue("--default-particle-count")) || 25;
  const PARTICLE_STDEV          = parseFloat(cssVars.getPropertyValue("--particle-stdev")) || 20;
  const PARTICLE_VELOCITY_SCALE = parseFloat(cssVars.getPropertyValue("--particle-velocity-scale")) || 0.2;
  const PARTICLE_LIFETIME_BASE  = parseFloat(cssVars.getPropertyValue("--particle-lifetime-base")) || 1000;
  const PARTICLE_LIFETIME_RANDOM= parseFloat(cssVars.getPropertyValue("--particle-lifetime-random")) || 1000;
  const PARTICLE_SATURATION = cssVars.getPropertyValue("--particle-saturation").trim() || "100%";
  const PARTICLE_LIGHTNESS  = cssVars.getPropertyValue("--particle-lightness").trim()  || "60%";

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let isPlaying = false;

  // The scale
  let scaleDegrees = [
    { fractionText: "1/1", floatVal: 1.0, selected: false },
    { fractionText: "2/1", floatVal: 2.0, selected: false }
  ];
  let tonic = 261.63;

  // Particles
  let particles = [];

  // Canvas + geometry
  const canvas = document.getElementById("scale-canvas");
  const ctx = canvas.getContext("2d");
  let LEFT_X=0, RIGHT_X=0, MID_Y=0, WIDTH=0;

  // For dragging
  let draggingMarker = null;

  // For clickable labels
  let clickableRegions = [];

  // For snapping
  const MAX_DEN = 16;
  const SNAP_THRESHOLD_CENTS = 10;
  let snapCandidates = [];

  /**************************************************************************
   * 2) Main Initialization
   **************************************************************************/
  window.addEventListener("DOMContentLoaded", init);
  function init(){
    // Basic references
    const noteSelect = document.getElementById("noteSelect");
    const tonicInput = document.getElementById("tonicInput");

    tonic = parseFloat(noteSelect.value);
    tonicInput.value = noteSelect.value;

    noteSelect.addEventListener("change", () => {
      tonic = parseFloat(noteSelect.value);
      tonicInput.value = noteSelect.value;
    });

    document.getElementById("setTonicBtn").addEventListener("click", () => {
      let val = parseFloat(tonicInput.value);
      if(!isFinite(val) || val <= 0){
        alert("Tonic must be positive.");
        return;
      }
      tonic = val;
    });

    const intervalInput = document.getElementById("intervalInput");
    document.getElementById("addIntervalBtn").addEventListener("click", () => {
      let text = intervalInput.value.trim();
      if(!text){
        alert("Enter ratio, e.g. 3/2 or 1.414");
        return;
      }
      let r = parseFractionOrDecimal(text);
      if(!isFinite(r) || r <= 1 || r >= 2){
        alert("Ratio must be >1 and <2");
        return;
      }
      let exist = scaleDegrees.some(d => Math.abs(d.floatVal - r) < 1e-7);
      if(!exist){
        scaleDegrees.push({ fractionText: text, floatVal: r, selected: false });
        scaleDegrees.sort((a,b)=>a.floatVal - b.floatVal);
      }
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      // Keep only 1/1 and 2/1
      scaleDegrees = scaleDegrees.filter(d => d.floatVal === 1 || d.floatVal === 2);
    });

    document.getElementById("playScaleBtn").addEventListener("click", async () => {
      if(isPlaying) return;
      isPlaying = true;
      setControlsEnabled(false);
      await playScaleOnce();
      setControlsEnabled(true);
      isPlaying = false;
    });

    document.getElementById("saveBtn").addEventListener("click", doSave);
    document.getElementById("loadBtn").addEventListener("click", () => {
      document.getElementById("fileInput").click();
    });
    document.getElementById("fileInput").addEventListener("change", evt => {
      doLoad(evt.target.files);
      evt.target.value = "";
    });

    document.getElementById("presetSelect").addEventListener("change", applyPresetSelection);

    initSnapCandidates();
    resizeCanvas();
    canvas.addEventListener("mousedown", onCanvasMouseDown);
    canvas.addEventListener("mousemove", onCanvasMouseMove);
    canvas.addEventListener("mouseup",   ()=>{ draggingMarker=null; });
    canvas.addEventListener("mouseleave",()=>{ draggingMarker=null; });

    // Start the render loop
    requestAnimationFrame(animate);
  }

  /**************************************************************************
   * 3) Animation Loop
   **************************************************************************/
  function animate(){
    requestAnimationFrame(animate);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    updateParticles();
    drawParticles();
    renderScale();
  }

  /**************************************************************************
   * 4) Particle System
   **************************************************************************/
  function createParticles(x, y, ratio, count=DEFAULT_PARTICLE_COUNT){
    let now = performance.now();
    for(let i=0; i<count; i++){
      let [dx, dy] = sample2DNormal(0, PARTICLE_STDEV);
      let vx = PARTICLE_VELOCITY_SCALE * (Math.random()*2 - 1);
      let vy = PARTICLE_VELOCITY_SCALE * (Math.random()*2 - 1);
      let lifetime = PARTICLE_LIFETIME_BASE + Math.random() * PARTICLE_LIFETIME_RANDOM;
      let hue = ratioToHue(ratio);
      let color = `hsl(${hue}, ${PARTICLE_SATURATION}, ${PARTICLE_LIGHTNESS})`;
      particles.push({
        x: x + dx,
        y: y + dy,
        vx, vy,
        lifetime,
        born: now,
        color
      });
    }
  }

  function sample2DNormal(mean, stdDev){
    let u1 = Math.random(), u2 = Math.random();
    let r = Math.sqrt(-2 * Math.log(u1));
    let theta = 2 * Math.PI * u2;
    return [
      r * Math.cos(theta) * stdDev + mean,
      r * Math.sin(theta) * stdDev + mean
    ];
  }

  function updateParticles(){
    let now = performance.now();
    particles = particles.filter(p => (now - p.born) < p.lifetime);
    for(let p of particles){
      p.x += p.vx;
      p.y += p.vy;
    }
  }

  function drawParticles(){
    let now = performance.now();
    for(let p of particles){
      let age = now - p.born;
      let lifeFrac = age / p.lifetime;
      if(lifeFrac > 1) lifeFrac = 1;

      let alpha = 1 - lifeFrac;
      let size  = 2 - 1.5 * lifeFrac; 

      ctx.save();
      ctx.globalAlpha = alpha;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, size, 0, 2*Math.PI);
      ctx.fill();
      ctx.restore();
    }
  }

  /**************************************************************************
   * 5) Rendering the Scale
   **************************************************************************/
  function resizeCanvas(){
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
  }

  function renderScale(){
    clickableRegions = [];
    LEFT_X = 0.08 * canvas.width;
    RIGHT_X= 0.92 * canvas.width;
    MID_Y  = canvas.height / 2;
    WIDTH  = RIGHT_X - LEFT_X;

    // main horizontal line
    ctx.strokeStyle = cssVars.getPropertyValue("--canvas-line-color").trim() || "#0af";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(LEFT_X, MID_Y);
    ctx.lineTo(RIGHT_X, MID_Y);
    ctx.stroke();

    scaleDegrees.sort((a,b)=>a.floatVal - b.floatVal);

    // interval labels
    ctx.font = "20px JetBrains Mono";
    ctx.fillStyle = cssVars.getPropertyValue("--interval-label-color").trim() || "#fffbcc";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let placedLabels = [];
    for(let i=0; i<scaleDegrees.length-1; i++){
      let leftVal = scaleDegrees[i].floatVal;
      let rightVal= scaleDegrees[i+1].floatVal;
      let gap = rightVal/leftVal;
      let mid = (leftVal + rightVal)/2;
      let midX= ratioToX(mid, LEFT_X, WIDTH);
      let gapStr = fractionStringApprox(gap);
      let lbl = positionLabel(midX, MID_Y-50, gapStr, "interval", placedLabels);
      drawLabel(lbl);
    }

    // draw each scale degree
    for(let deg of scaleDegrees){
      let x = ratioToX(deg.floatVal, LEFT_X, WIDTH);

      // vertical line
      ctx.strokeStyle = cssVars.getPropertyValue("--canvas-vertical-line-color").trim() || "#66b0ff";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, MID_Y - 70);
      ctx.lineTo(x, MID_Y + 70);
      ctx.stroke();

      // ratio label
      ctx.font = "20px JetBrains Mono";
      ctx.fillStyle = cssVars.getPropertyValue("--ratio-label-color").trim() || "#f0c";
      let ratioLbl = positionLabel(x, MID_Y - 90, deg.fractionText, "ratio", placedLabels);
      ratioLbl.degree = deg;
      drawLabel(ratioLbl);

      // freq label
      ctx.font = "20px JetBrains Mono";
      ctx.fillStyle = cssVars.getPropertyValue("--freq-label-color").trim() || "#0ff";
      let freqVal = deg.floatVal * tonic;
      let freqStr = freqVal.toFixed(2) + " Hz";
      let freqLbl = positionLabel(x, MID_Y + 90, freqStr, "freq", placedLabels, true);
      freqLbl.degree = deg;
      drawLabel(freqLbl);

      // selected checkbox
      let checkBoxSize = 20;
      let checkBoxX = x - checkBoxSize/2;
      let checkBoxY = ratioLbl.y - 30;
      registerClickable(checkBoxX, checkBoxY, checkBoxSize, checkBoxSize, () => {
        deg.selected = !deg.selected;
      });
      ctx.save();
      ctx.strokeStyle = cssVars.getPropertyValue("--ratio-label-color").trim() || "#f0c";
      ctx.lineWidth = 2;
      ctx.strokeRect(checkBoxX, checkBoxY, checkBoxSize, checkBoxSize);
      if(deg.selected){
        ctx.beginPath();
        ctx.moveTo(checkBoxX, checkBoxY);
        ctx.lineTo(checkBoxX+checkBoxSize, checkBoxY+checkBoxSize);
        ctx.moveTo(checkBoxX+checkBoxSize, checkBoxY);
        ctx.lineTo(checkBoxX, checkBoxY+checkBoxSize);
        ctx.stroke();
      }
      ctx.restore();
    }
  }

  function ratioToX(r, leftX, width){
    let t = (r - 1)/(2 - 1);
    return leftX + t*width;
  }

  function positionLabel(cx, cy, text, kind, placedLabels, below=false){
    let metrics = ctx.measureText(text);
    let textWidth  = metrics.width;
    let textHeight = (kind==="interval"?30 : (kind==="ratio"?24 : 28));
    let labelY = cy;
    let step = below ? 5 : -5;
    let attempts = 40;
    for(let i=0; i<attempts; i++){
      let x0 = cx - textWidth/2;
      let y0 = labelY - textHeight/2;
      let box = {x:x0, y:y0, w:textWidth, h:textHeight};
      if(!collides(box, placedLabels)){
        placedLabels.push(box);
        return {x: x0, y: y0, w: textWidth, h: textHeight, text, kind};
      }
      labelY += step;
    }
    // fallback
    let x0 = cx - textWidth/2;
    let y0 = cy - textHeight/2;
    placedLabels.push({x:x0,y:y0,w:textWidth,h:textHeight});
    return {x:x0,y:y0,w:textWidth,h:textHeight,text,kind};
  }

  function collides(box, boxes){
    for(let b of boxes){
      if(!(box.x+box.w < b.x || box.x > b.x+b.w ||
           box.y+box.h < b.y || box.y > b.y+b.h)){
        return true;
      }
    }
    return false;
  }

  function drawLabel(label){
    let {x,y,w,h,text,kind} = label;
    let cx = x + w/2;
    let cy = y + h/2;

    ctx.save();
    if(kind==="interval"){
      ctx.fillStyle = cssVars.getPropertyValue("--interval-label-color").trim() || "#fffbcc";
    } else if(kind==="ratio"){
      ctx.fillStyle = cssVars.getPropertyValue("--ratio-label-color").trim() || "#f0c";
    } else if(kind==="freq"){
      ctx.fillStyle = cssVars.getPropertyValue("--freq-label-color").trim() || "#0ff";
    }
    ctx.font = "20px JetBrains Mono";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, cx, cy);
    ctx.restore();

    // ratio => click to delete
    if(kind==="ratio"){
      registerClickable(x,y,w,h,()=>{
        if(label.degree.floatVal===1 || label.degree.floatVal===2) return;
        if(confirm(`Delete "${label.degree.fractionText}"?`)){
          scaleDegrees = scaleDegrees.filter(d=>d!==label.degree);
        }
      });
    }
    // freq => click for chord
    else if(kind==="freq"){
      registerClickable(x,y,w,h,()=>{
        let baseDeg = label.degree;
        let px = ratioToX(baseDeg.floatVal, LEFT_X, WIDTH);
        createParticles(px, MID_Y, baseDeg.floatVal, 40);
        let others = scaleDegrees.filter(d=>d.selected && d!==baseDeg);
        for(let o of others){
          let ox = ratioToX(o.floatVal, LEFT_X, WIDTH);
          createParticles(ox, MID_Y, o.floatVal, 40);
        }
        let freq = baseDeg.floatVal * tonic;
        let allFreqs = [freq, ...others.map(o=>o.floatVal*tonic)];
        playNotesSimult(allFreqs);
      });
    }
  }

  /**************************************************************************
   * 6) Mouse / Drag
   **************************************************************************/
  function onCanvasMouseDown(evt){
    let rect = canvas.getBoundingClientRect();
    let mx = evt.clientX - rect.left;
    let my = evt.clientY - rect.top;

    let marker = getMarkerAtPosition(mx, my);
    if(marker){
      draggingMarker = marker;
      return;  // <--- ensure we do not do label checks if on marker
    }
    // otherwise check labels
    for(let i=clickableRegions.length-1; i>=0; i--){
      let r = clickableRegions[i];
      if(mx>=r.x && mx<=r.x+r.w && my>=r.y && my<=r.y+r.h){
        r.callback(evt);
        break;
      }
    }
  }

  function onCanvasMouseMove(evt){
    if(!draggingMarker) return;
    let rect = canvas.getBoundingClientRect();
    let mx = evt.clientX - rect.left;

    // map mouse X -> ratio in [1.0001..1.9999]
    let newRatio = xToRatio(mx, LEFT_X, WIDTH);
    newRatio = Math.max(1.0001, Math.min(newRatio, 1.9999));
    let snapped = maybeSnap(newRatio);
    draggingMarker.floatVal = snapped;
    draggingMarker.fractionText = fractionStringApprox(snapped);

    // spawn a few particles
    let xPos = ratioToX(snapped, LEFT_X, WIDTH);
    createParticles(xPos, MID_Y, snapped, 5);
  }

  function getMarkerAtPosition(mx, my){
    // skip 1/1 + 2/1
    for(let deg of scaleDegrees){
      if(deg.floatVal===1 || deg.floatVal===2) continue;
      let lineX = ratioToX(deg.floatVal, LEFT_X, WIDTH);

      let lineTop = MID_Y - 70;
      let lineBottom = MID_Y + 70;
      if(my>=lineTop && my<=lineBottom && Math.abs(mx-lineX)<=DRAG_TOLERANCE_PX){
        return deg;
      }
    }
    return null;
  }

  function xToRatio(mouseX, leftX, width){
    let t = (mouseX - leftX)/width;
    return 1 + t*(2 - 1);
  }

  function registerClickable(x,y,w,h,callback){
    clickableRegions.push({x,y,w,h,callback});
  }

  /**************************************************************************
   * 7) Audio / Playback
   **************************************************************************/
  async function playScaleOnce(){
    let sorted = [...scaleDegrees].sort((a,b)=>a.floatVal - b.floatVal);
    let noteDur = 0.5;
    for(let deg of sorted){
      let px = ratioToX(deg.floatVal, LEFT_X, WIDTH);
      createParticles(px, MID_Y, deg.floatVal, 20);
      let freq = deg.floatVal * tonic;
      await playOneNoteSequential(freq, noteDur);
    }
  }

  function playOneNoteSequential(freq, duration){
    return new Promise(async resolve=>{
      if(audioCtx.state==="suspended"){
        await audioCtx.resume();
      }
      const now = audioCtx.currentTime;
      let osc = audioCtx.createOscillator();
      let gain= audioCtx.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, now);

      let baseAmp = 0.2;
      let freqWeight = Math.sqrt(440/freq);
      let finalAmp = baseAmp*freqWeight;
      if(finalAmp>0.8) finalAmp=0.8;

      gain.gain.setValueAtTime(finalAmp, now);
      gain.gain.linearRampToValueAtTime(0, now+duration);

      osc.connect(gain).connect(audioCtx.destination);
      osc.onended=()=>resolve();
      osc.start(now);
      osc.stop(now+duration);
    });
  }

  async function playNotesSimult(freqArray){
    if(audioCtx.state==="suspended"){
      await audioCtx.resume();
    }
    let n = freqArray.length;
    if(n<1) return;
    const now = audioCtx.currentTime;
    const duration = 1.0;
    for(let freq of freqArray){
      let osc = audioCtx.createOscillator();
      let gain= audioCtx.createGain();

      osc.type = "triangle";
      osc.frequency.setValueAtTime(freq, now);

      let baseAmp = 0.2 / n;
      let freqWeight = Math.sqrt(440/freq);
      let finalAmp = baseAmp * freqWeight;
      if(finalAmp>0.8) finalAmp=0.8;

      gain.gain.setValueAtTime(finalAmp, now);
      gain.gain.linearRampToValueAtTime(0, now+duration);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now+duration);
    }
  }

  /**************************************************************************
   * 8) Snapping
   **************************************************************************/
  function initSnapCandidates(){
    snapCandidates=[];
    for(let d=1; d<=MAX_DEN; d++){
      for(let n=1; n<2*d; n++){
        let ratio = n/d;
        if(ratio<=1 || ratio>=2) continue;
        if(gcd(n,d)===1){
          snapCandidates.push({ ratio, num:n, den:d });
        }
      }
    }
    snapCandidates.sort((a,b)=>a.ratio - b.ratio);
  }

  function gcd(a,b){
    return b ? gcd(b,a%b) : a;
  }

  function maybeSnap(ratio){
    let best = ratio;
    let bestDiff = Infinity;
    for(let cand of snapCandidates){
      let centsDiff = 1200*Math.abs(Math.log2(ratio/cand.ratio));
      if(centsDiff<SNAP_THRESHOLD_CENTS && centsDiff<bestDiff){
        best = cand.ratio;
        bestDiff = centsDiff;
      }
    }
    return best;
  }

  /**************************************************************************
   * 9) Presets
   **************************************************************************/
  function applyPresetSelection(){
    let val = document.getElementById("presetSelect").value;
    let [type, numStr] = val.split("-");
    if(!type) return;
    if(type==="custom"){
      alert("Custom preset is not yet implemented. Coming soon!");
      return;
    }
    if(!confirm("This will overwrite current intervals. Continue?")) return;
    scaleDegrees = [
      { fractionText:"1/1", floatVal:1.0, selected:false },
      { fractionText:"2/1", floatVal:2.0, selected:false }
    ];
    let n = parseInt(numStr,10);
    if(type==="harmonic"){
      for(let i=n+1; i<=2*n; i++){
        let valf = i/n;
        if(Math.abs(valf-1)<1e-7 || Math.abs(valf-2)<1e-7) continue;
        scaleDegrees.push({ fractionText: i+"/"+n, floatVal: valf, selected:false });
      }
    }
    else if(type==="equal"){
      for(let k=1; k<n; k++){
        let valf = Math.pow(2, k/n);
        if(Math.abs(valf-1)<1e-7 || Math.abs(valf-2)<1e-7) continue;
        scaleDegrees.push({ fractionText:`2^(${k}/${n})`, floatVal:valf, selected:false });
      }
    }
    scaleDegrees.sort((a,b)=>a.floatVal - b.floatVal);
  }

  /**************************************************************************
   * 10) Save/Load
   **************************************************************************/
  function doSave(){
    const formatSelect = document.getElementById("formatSelect");
    let format = formatSelect.value;
    const refMidi = parseInt(document.getElementById("refMidiNoteInput").value,10) || 60;
    const refFreq = parseFloat(document.getElementById("refFreqInput").value) || 261.63;
    const lowestMidi = parseInt(document.getElementById("lowestNoteInput").value,10)||0;
    const highestMidi= parseInt(document.getElementById("highestNoteInput").value,10)||127;

    let fileContent="", fileExtension="";
    if(format==="json"){
      let data = {
        tonic: tonic,
        scaleDegrees: scaleDegrees.map(d => ({
          fractionText: d.fractionText,
          floatVal: d.floatVal,
          selected: d.selected
        }))
      };
      fileContent = JSON.stringify(data,null,2);
      fileExtension="json";
      downloadFile(fileContent, fileExtension);
    }
    else if(format==="scl"){
      fileContent = generateSclFileContent("My Scale", scaleDegrees);
      fileExtension="scl";
      downloadFile(fileContent, fileExtension);
    }
    else if(format==="scl_kbm"){
      let sclContent = generateSclFileContent("My Scale", scaleDegrees);
      let kbmContent = generateKbmFileContent("My Scale Mapping", scaleDegrees, refMidi, refFreq, lowestMidi, highestMidi);
      downloadFile(sclContent,"scl");
      setTimeout(()=>downloadFile(kbmContent,"kbm"), 500);
    }
    else if(format==="tun"){
      fileContent = generateTunFileContent(scaleDegrees, refMidi, refFreq);
      fileExtension="tun";
      downloadFile(fileContent, fileExtension);
    }
  }

  function downloadFile(content,extension){
    let now = new Date();
    let YYYY = now.getFullYear();
    let MM   = String(now.getMonth()+1).padStart(2,"0");
    let DD   = String(now.getDate()).padStart(2,"0");
    let hh   = String(now.getHours()).padStart(2,"0");
    let mm   = String(now.getMinutes()).padStart(2,"0");
    let userCount = scaleDegrees.length - 2;
    let fileName = `scale-${YYYY}${MM}${DD}-${hh}${mm}-${userCount}.${extension}`;
    let blob = new Blob([content], {type:"text/plain"});
    let url  = URL.createObjectURL(blob);
    let a    = document.createElement("a");
    a.href   = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function doLoad(fileList){
    if(!fileList || fileList.length<1) return;
    let file = fileList[0];
    let reader = new FileReader();
    reader.onload = e =>{
      try{
        let data = JSON.parse(e.target.result);
        if(!data.scaleDegrees || !Array.isArray(data.scaleDegrees)){
          alert("Invalid file format: no scaleDegrees array found.");
          return;
        }
        if(!confirm("Loading will overwrite current intervals. Continue?")) return;
        tonic = data.tonic || 261.63;
        scaleDegrees = data.scaleDegrees.map(d=>({
          fractionText: d.fractionText,
          floatVal: d.floatVal,
          selected: !!d.selected
        }));
        scaleDegrees.sort((a,b)=>a.floatVal - b.floatVal);
      } catch(err){
        alert("Error parsing JSON: "+err);
        console.error(err);
      }
    };
    reader.readAsText(file);
  }

  function generateSclFileContent(scaleName, scaleDegrees){
    let sorted = [...scaleDegrees].sort((a,b)=>a.floatVal - b.floatVal);
    let relevant = sorted.filter(d=>d.floatVal<2.000001);
    let numIntervals = relevant.length -1;
    if(numIntervals<1) numIntervals=1;
    let lines=[];
    lines.push(`! ${scaleName}`);
    lines.push(`${scaleName}`);
    lines.push(`${numIntervals}`);
    lines.push("!");
    for(let i=1; i<relevant.length; i++){
      let ratio = relevant[i].floatVal;
      let cents = 1200*Math.log2(ratio);
      lines.push(cents.toFixed(5));
    }
    return lines.join("\n")+"\n";
  }

  function generateKbmFileContent(comment, scaleDegrees, refMidi, refFreq, lowestMidi, highestMidi){
    let lines=[];
    lines.push(`! ${comment}`);
    lines.push("!");
    const mapSize = (highestMidi - lowestMidi)+1;
    lines.push(`${mapSize}`);
    lines.push(`${lowestMidi}`);
    lines.push(`${highestMidi}`);
    lines.push(`${refMidi}`);
    lines.push("0");
    lines.push(`! Reference frequency for MIDI note ${refMidi} = ${refFreq.toFixed(3)} Hz`);
    let sorted = [...scaleDegrees].sort((a,b)=>a.floatVal - b.floatVal);
    const scaleCount = sorted.length;
    for(let k=lowestMidi; k<=highestMidi; k++){
      let cycleLen = scaleCount-1;
      if(cycleLen<1) cycleLen=1;
      let indexInScale = (k - lowestMidi) % cycleLen;
      lines.push(`${indexInScale}`);
    }
    return lines.join("\n")+"\n";
  }

  function generateTunFileContent(scaleDegrees, refMidi, refFreq){
    let sorted=[...scaleDegrees].sort((a,b)=>a.floatVal - b.floatVal);
    let lines=[];
    lines.push("! Generated by Scale WKSP");
    lines.push("table begin");
    for(let i=0; i<sorted.length; i++){
      let ratio=sorted[i].floatVal;
      let cents=1200*Math.log2(ratio);
      lines.push(` ${i+1}) ${cents.toFixed(5)}`);
    }
    lines.push("table end");
    lines.push("octave 1200.0");
    lines.push(`middle note ${refMidi}`);
    lines.push(`base freq ${refFreq.toFixed(5)}`);
    return lines.join("\n")+"\n";
  }

  /**************************************************************************
   * 11) Misc Utility
   **************************************************************************/
  function setControlsEnabled(enabled){
    document.querySelectorAll(".controls button, .controls input, .controls select")
      .forEach(el => { el.disabled = !enabled; });
  }

  function fractionStringApprox(x){
    const maxDenom = 1000000;
    const [num, den] = bestRationalApproximation(x, maxDenom);
    const approx = num/den;
    const error = Math.abs(x - approx);
    let result = `${num}/${den}`;
    if(error>0.01) result = "~" + result;
    return result;
  }

  function bestRationalApproximation(x, maxDen){
    let pPrevPrev=0, pPrev=1;
    let qPrevPrev=1, qPrev=0;
    let fraction=x;
    let a=Math.floor(fraction);
    let p=a*pPrev + pPrevPrev;
    let q=a*qPrev + qPrevPrev;
    while(true){
      let remainder = fraction - a;
      if(Math.abs(remainder)<1e-12) break;
      fraction=1/remainder;
      a=Math.floor(fraction);
      let pNext=a*p + pPrev;
      let qNext=a*q + qPrev;
      if(qNext>maxDen) break;
      pPrevPrev=pPrev; qPrevPrev=qPrev;
      pPrev=p; qPrev=q;
      p=pNext; q=qNext;
    }
    return [p,q];
  }

  function parseFractionOrDecimal(s){
    s = s.trim();
    if(!s) return NaN;
    if(s.includes("^")){
      let match = s.match(/^(.+)\^(.+)$/);
      if(!match) return NaN;
      let baseStr = match[1].replace(/^\(+/,"").replace(/\)+$/,"");
      let expStr  = match[2].replace(/^\(+/,"").replace(/\)+$/,"");
      let baseVal = parseFractionOrDecimal(baseStr);
      let expVal  = parseFractionOrDecimal(expStr);
      if(!isFinite(baseVal) || !isFinite(expVal)) return NaN;
      return Math.pow(baseVal, expVal);
    }
    if(s.includes("/")){
      let parts = s.split("/");
      if(parts.length!==2) return NaN;
      let num = parseFloat(parts[0]);
      let den = parseFloat(parts[1]);
      if(!isFinite(num)||!isFinite(den)||den===0) return NaN;
      return num/den;
    }
    return parseFloat(s);
  }

  function ratioToHue(ratio){
    let t = ratio - 1;
    return 300 * t;
  }
</script>
</body>
</html>
