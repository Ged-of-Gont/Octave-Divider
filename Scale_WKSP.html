<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Scale Workshop (Neon Tron Style)</title>
  <style>
    /* Overall page style */
    body {
      margin: 0;
      padding: 0;
      background-color: #0b0f1a; /* Dark bluish background */
      color: #e0e0e0;
      font-family: "Trebuchet MS", Arial, sans-serif;
      font-size: 16px;
    }
    header {
      padding: 1rem;
      background: linear-gradient(90deg, #112, #224);
      color: #00ffe0;
      text-shadow: 1px 1px #000;
      border-bottom: 2px solid #09aa9a;
      font-size: 1.4rem;
    }
    .controls {
      margin: 1rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
    }
    label, select, input, button {
      font-size: 1.1rem;
    }
    input[type="number"], input[type="text"] {
      padding: 5px;
      width: 90px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #101828;
      color: #ccffff;
      outline: none;
    }
    select {
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #101828;
      color: #99ffff;
    }
    button {
      background: #0fd2ba;
      color: #002;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      box-shadow: 2px 2px 4px #000;
    }
    button:hover {
      background: #0aa;
      color: #fff;
    }

    /* Container for the scale line (SVG) */
    #scale-container {
      margin: 1rem auto;
      background: #142030;
      border: 2px solid #09aa9a;
      border-radius: 10px;
      padding: 0.5rem;
      width: 1200px; /* Wider so text doesn't get cut off */
    }
    #scale-svg {
      width: 100%;    /* Responsive */
      height: 600px;  /* Taller so no cutoff */
      overflow: visible;
      background: #0b0f1a; /* matches body background, can adjust as needed */
      display: block;
    }

    /* SVG text styles */
    .intervalLabel {
      fill: #fffbcc;
      font-size: 22px;
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none; /* Not clickable */
    }
    .degreeLabel {
      fill: #f0c;  /* Neon pink/purple for the fraction label */
      font-size: 24px;
      font-weight: bold;
      text-anchor: middle;
      cursor: pointer; /* So user sees a pointer when hovering */
      text-shadow: 1px 1px 2px #000;
    }
    .freqLabel {
      fill: #0ff;  /* Neon cyan for frequency */
      font-size: 22px;
      text-anchor: middle;
      cursor: pointer;
      text-shadow: 1px 1px 2px #000;
    }
    .mainLine {
      stroke: #0af;
      stroke-width: 3px;
    }
    .tickLine {
      stroke: #66b0ff;
      stroke-width: 2px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Scale Workshop (Neon Tron Style)</h1>
  </header>

  <div class="controls">
    <label>Tonic Frequency:</label>
    <input id="tonicInput" type="number" value="261.63" step="0.01" />
    <select id="noteSelect">
      <option value="220">A3 (~220 Hz)</option>
      <option value="246.94">B3 (~246.94 Hz)</option>
      <option value="261.63" selected>C4 (~261.63 Hz)</option>
      <option value="293.66">D4 (~293.66 Hz)</option>
      <option value="329.63">E4 (~329.63 Hz)</option>
      <option value="349.23">F4 (~349.23 Hz)</option>
      <option value="392.0">G4 (392 Hz)</option>
      <option value="440.0">A4 (440 Hz)</option>
      <option value="493.88">B4 (~493.88 Hz)</option>
    </select>
    <button id="setTonicBtn">Set Tonic</button>

    <label>New Interval (1 &lt; x &lt; 2):</label>
    <input id="intervalInput" type="text" placeholder="3/2 or 1.414" />
    <button id="addIntervalBtn">Add Interval</button>
  </div>

  <div id="scale-container">
    <svg id="scale-svg"></svg>
  </div>

<script>
// We’ll keep an array of objects, each representing a scale degree:
//   { fractionText: "3/2", floatVal: 1.5 }
// Always include the unison:  { fractionText: "1/1", floatVal: 1.0 }
// and the octave:             { fractionText: "2/1", floatVal: 2.0 }
let scaleDegrees = [
  { fractionText: "1/1", floatVal: 1.0 },
  { fractionText: "2/1", floatVal: 2.0 }
];

// Tonic frequency (default = ~C4)
let tonic = 261.63;

// We’ll set up a 1200px-wide by 600px-high space in the SVG
// A linear mapping from [1.0, 2.0] in ratio space to [0, 1200] in x-coords:
const SVG_WIDTH = 1200;
const SVG_HEIGHT = 600;
const centerY = 300; // horizontal line in the middle of the 600px canvas

// For Web Audio playback
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

//--------------------- UI SETUP --------------------------
window.addEventListener("DOMContentLoaded", init);

function init() {
  const noteSelect = document.getElementById("noteSelect");
  const tonicInput = document.getElementById("tonicInput");
  const setTonicBtn = document.getElementById("setTonicBtn");
  const intervalInput = document.getElementById("intervalInput");
  const addIntervalBtn = document.getElementById("addIntervalBtn");

  // Keep the line edit synced with the dropdown
  noteSelect.addEventListener("change", () => {
    tonicInput.value = noteSelect.value;
  });

  setTonicBtn.addEventListener("click", () => {
    const val = parseFloat(tonicInput.value);
    if (!isFinite(val) || val <= 0) {
      alert("Tonic must be a positive number.");
      return;
    }
    tonic = val;
    drawScale();
  });

  addIntervalBtn.addEventListener("click", () => {
    const text = intervalInput.value.trim();
    if (!text) {
      alert("Enter a ratio (e.g., 3/2).");
      return;
    }
    const floatVal = parseFractionOrDecimal(text);
    if (!isFinite(floatVal)) {
      alert("Invalid ratio format. Try something like 3/2 or 1.414.");
      return;
    }
    if (floatVal <= 1.0 || floatVal >= 2.0) {
      alert("Ratio must be > 1.0 and < 2.0!");
      return;
    }
    // Insert if it’s not already in the array:
    const already = scaleDegrees.some(d => Math.abs(d.floatVal - floatVal) < 1e-7);
    if (!already) {
      scaleDegrees.push({ fractionText: text, floatVal: floatVal });
    }
    // Always sort by floatVal
    scaleDegrees.sort((a, b) => a.floatVal - b.floatVal);
    drawScale();
  });

  // Initial draw
  drawScale();
}

//--------------------- PARSE HELPER -----------------------
function parseFractionOrDecimal(s) {
  // If user typed something like "3/2"
  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return NaN;
    const num = parseFloat(parts[0]);
    const den = parseFloat(parts[1]);
    if (!isFinite(num) || !isFinite(den) || den === 0) return NaN;
    return num / den;
  } else {
    // else parse as decimal
    return parseFloat(s);
  }
}

//--------------------- DRAWING THE SCALE ------------------
function drawScale() {
  const svg = document.getElementById("scale-svg");
  // Clear old content
  svg.innerHTML = "";

  // Full width/height in the <svg>
  svg.setAttribute("viewBox", `0 0 ${SVG_WIDTH} ${SVG_HEIGHT}`);

  // 1) Draw the main horizontal line
  const mainLine = createSVG("line", {
    x1: 0, y1: centerY,
    x2: SVG_WIDTH, y2: centerY,
    class: "mainLine"
  });
  svg.appendChild(mainLine);

  // 2) Sort degrees by floatVal, ensure we keep 1.0 -> 2.0
  scaleDegrees.sort((a, b) => a.floatVal - b.floatVal);

  // 3) Intervals between consecutive degrees
  for (let i = 0; i < scaleDegrees.length - 1; i++) {
    const left = scaleDegrees[i].floatVal;
    const right = scaleDegrees[i+1].floatVal;
    const gap = right / left;
    const mid = (left + right) / 2;
    const midX = ratioToX(mid);

    // Draw interval text above line
    const intervalText = createSVG("text", {
      x: midX,
      y: centerY - 30,
      class: "intervalLabel"
    });
    intervalText.textContent = fractionStringApprox(gap);
    svg.appendChild(intervalText);
  }

  // 4) For each degree, draw the vertical tick line + ratio label + freq label
  scaleDegrees.forEach(deg => {
    const x = ratioToX(deg.floatVal);

    // Tick line
    const tick = createSVG("line", {
      x1: x, y1: centerY - 40,
      x2: x, y2: centerY + 40,
      class: "tickLine"
    });
    svg.appendChild(tick);

    // Ratio label (above). Clickable to remove (except unison/octave).
    const ratioTxt = createSVG("text", {
      x: x,
      y: centerY - 60,
      class: "degreeLabel"
    });
    ratioTxt.textContent = deg.fractionText;
    // Only removable if not 1.0 or 2.0
    if (deg.floatVal !== 1.0 && deg.floatVal !== 2.0) {
      ratioTxt.addEventListener("click", () => {
        if (confirm(`Delete scale degree "${deg.fractionText}"?`)) {
          scaleDegrees = scaleDegrees.filter(d => d !== deg);
          drawScale();
        }
      });
    }
    svg.appendChild(ratioTxt);

    // Frequency label (below). Clickable to play tone.
    const freqVal = deg.floatVal * tonic;
    const freqTxt = createSVG("text", {
      x: x,
      y: centerY + 60,
      class: "freqLabel"
    });
    freqTxt.textContent = freqVal.toFixed(4) + " Hz";
    freqTxt.addEventListener("click", () => {
      playTone(freqVal);
    });
    svg.appendChild(freqTxt);
  });
}

// A linear mapping from [1.0..2.0] -> [0..SVG_WIDTH]
function ratioToX(r) {
  // fraction (r-1)/1 => 0..1 range
  const frac = r - 1.0; // e.g. 3/2 => 0.5
  return frac * SVG_WIDTH; // so 0.0 => 0 px, 1.0 => 1200 px
}

// Return an approximate fraction or short decimal for display
function fractionStringApprox(value) {
  // We can just re-use parseFractionOrDecimal in reverse, but let's do a quick approach:
  // Or do fraction rounding with denominator up to 32:
  const approx = rationalApprox(value, 32);
  if (approx.den === 1) return `${approx.num}/1`;
  return `${approx.num}/${approx.den}`;
}

// Utility: approximate a float as a fraction up to a given denominator
function rationalApprox(value, maxDen) {
  // Farey or continued fraction approach. We'll do a simple approach here:
  let bestNum = 1, bestDen = 1;
  let bestError = Math.abs(value - bestNum/bestDen);

  for (let den = 1; den <= maxDen; den++) {
    let num = Math.round(value * den);
    let val = num / den;
    let err = Math.abs(value - val);
    if (err < bestError) {
      bestError = err;
      bestNum = num;
      bestDen = den;
    }
  }
  return { num: bestNum, den: bestDen };
}

// Create an SVG element of a given type, setting attributes from an object
function createSVG(tagName, attrs) {
  const el = document.createElementNS("http://www.w3.org/2000/svg", tagName);
  for (const [k, v] of Object.entries(attrs)) {
    el.setAttribute(k, v.toString());
  }
  return el;
}

//--------------------- AUDIO PLAYBACK ---------------------
function playTone(freq) {
  const duration = 1.0;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

  gain.gain.setValueAtTime(0.3, audioCtx.currentTime); // start amplitude
  gain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + duration);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}
</script>
</body>
</html>
